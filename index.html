
<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
    
	<script src="js/jquery-1.11.2.min.js"></script>
	<script type="text/javascript" src="js/paper-full.min.js"></script>
	<script type="text/paperscript" canvas="paperCanvas">
		
		(function() {
		  var requestAnimationFrame = window.requestAnimationFrame || window.mozRequestAnimationFrame ||
		                              window.webkitRequestAnimationFrame || window.msRequestAnimationFrame;
		  window.requestAnimationFrame = requestAnimationFrame;
		})();

		var video = document.getElementById('video');
		var canvas = document.getElementById('sourceCanvas');
		var width = $(window).width();
		var height = $(window).height();		
		var detection = {};
		var xParts = 90, yParts = 60;
		var blocksNum = xParts * yParts;
		var cloudShowed = false;
		var xSide = Math.floor(width/xParts);
		var ySide = Math.floor(height/yParts);
		var destination;

		function getWebcam(){
			

			navigator.getMedia =  navigator.getUserMedia || 
				navigator.webkitGetUserMedia ||
        navigator.mozGetUserMedia ||
        navigator.msGetUserMedia;

      if (navigator.getMedia) {
	   		navigator.getMedia (
		   		{
		   			video: true
		   		},
		 			function(localMediaStream){
	   				video.src = window.URL.createObjectURL(localMediaStream);
	   				video.onloadedmetadata = function(e) {
				      onFrame();	
				    };
					}, 
			   	function(e){
			   		console.log(e);
			   	}
				);
			}
		}

		

		function	onFrame (event) {
			var c = canvas.getContext('2d');
			c.save();
			c.scale(-1,1);
		  c.drawImage(video,-width,0,width,height);
		  c.restore();
		  var currentFrame = c.getImageData(0,0,width,height);
		    	
		  if(!detection.framesArray){
		   	detection.framesArray = [];
		    detection.framesArray.push(currentFrame); 
		  }
		  else{	
		    if (detection.framesArray[1] != null) {
		    	detection.framesArray.splice(0,1);
		    }
		    
		    detection.framesArray.push(currentFrame);
		   	detectMotion(detection.framesArray[0],detection.framesArray[1]);
		  }
		  	
		}
		
			

		// Detect motion

		function detectMotion(previous, current){
			
			var changed = [];
			for(var r = 0; r < yParts; r++){
				for(var c = 0; c < xParts; c++){
					var x = (c * xSide) + Math.floor(xSide/2);
					var y = (r * ySide) + Math.floor(ySide/2);
					var postition = (previous.width * 4) * y + x * 4;

					var dr = Math.abs(previous.data[postition]-current.data[postition]);
					var dg = Math.abs(previous.data[postition+1]-current.data[postition+1]);
					var db = Math.abs(previous.data[postition+2]-current.data[postition+2]);

					// motion detected
					if((dr+dg+db) >= 100 ){
						changed.push([c,r]);
					}			
				}
			}

			if (changed.length != 0) {
				var cSum = 0, changedNum = changed.length;

				for (var i = 0; i < changedNum; i++) {
					cSum += changed[i][0];
				}
				var cAve = Math.floor(cSum/changedNum);
				destination = new Point(cAve * xSide + Math.floor(xSide/2),100);
			}
			ball1.move(destination);

		}


		function Ball(position, radius) {
			this.path = new Path.Circle(position, radius);
			this.path.fillColor = '#f00';
			this.originPos = position;//Point

			this.move = function(destination) {
				if(destination != null){
					var vector = destination - this.path.position;
					this.path.position += vector * 0.1;
				}
			}

			this.back = function() {
				var vectorBack = this.originPos - this.path.position;
				this.path.position += vectorBack;
			}
		}

		canvas.width = width;
		canvas.height = height;

		var ball1 = new Ball(new Point(500, 100), 10);
		getWebcam();

	</script>	

	<style>
		body,html {
			margin: 0;
			padding: 0;
		}
		video {			
			display: none;
		}
		canvas {
			position: absolute;
			top: 0;
			left: 0;			
		}
		#sourceCanvas {
			display: none;
		}
		#paperCanvas {
			height: 100%;
			width: 100%;
		}
		img {
			display: none;
		}
	</style>
</head>
<body>
	<video id="video" autoplay></video>
	<canvas id="sourceCanvas"></canvas>
	<canvas id="paperCanvas"></canvas>
</html>