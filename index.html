
<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
    
	<script src="js/jquery-1.11.2.min.js"></script>
	<script type="text/javascript" src="js/paper-full.min.js"></script>
	<script type="text/paperscript" canvas="paperCanvas">
		
		var destination;

		function Frame() {
			this.previousFrame = null;
			this.currentFrame = null;
			this.canvas = document.getElementById('sourceCanvas');
			this.video = document.getElementById('video');
			this.xParts = 90;
			this.yParts = 60;
			this.xSide = Math.floor($(window).width() / this.xParts);
			this.ySide = Math.floor($(window).height() / this.yParts);
		}

		Frame.prototype.getStream = function() {
			navigator.getMedia = navigator.getUserMedia || 
				navigator.webkitGetUserMedia ||
        navigator.mozGetUserMedia ||
        navigator.msGetUserMedia;

      if (navigator.getMedia) {
	   		navigator.getMedia(
		   		{
		   			video: true
		   		},
		 			function(localMediaStream){
	   				this.video.src = window.URL.createObjectURL(localMediaStream);
	   				this.video.onloadedmetadata = function(e) {
				      onFrame();
				    }
					},
			   	function(e){
			   		console.log(e);
			   	}
				);
			}
		}

		Frame.prototype.drawCanvas = function() {
			var c = canvas.getContext('2d');
			c.save();
			c.scale(-1,1);
		  c.drawImage(video,-width,0,width,height);
		  c.restore();		 
		}

		Frame.prototype.storeFrames = function() {
			if (this.previous === null) {
				this.previous = c.getImageData(0,0,width,height);
			}
			else {
				if (this.current !== null) {
					this.previous = this.current;
				}
				this.current = c.getImageData(0,0,width,height);
				this.detect();
			}
		}

		Frame.prototype.detect = function() {
			var changed = [];

			var previous = this.previous;
			var current = this.current;

			for(var r = 0; r < this.yParts; r++){
				for(var c = 0; c < this.xParts; c++){
					var x = c * xSide + Math.floor(xSide/2);
					var y = r * ySide + Math.floor(ySide/2);
					var pixelPos = (previous.width * 4) * y + x * 4;

					var dr = Math.abs(previous.data[pixelPos]-current.data[pixelPos]);
					var dg = Math.abs(previous.data[pixelPos + 1]-current.data[pixelPos + 1]);
					var db = Math.abs(previous.data[pixelPos + 2]-current.data[pixelPos + 2]);

					// motion detected
					if((dr+dg+db) >= 100 ){
						changed.push([c,r]);
					}			
				}
			}

			if (changed.length != 0) {
				var cSum = 0, rSum = 0, changedNum = changed.length;

				for (var i = 0; i < changedNum; i++) {
					cSum += changed[i][0];
					rSum += changed[i][1];
				}

				var gX = Math.floor(cSum/changedNum) * xSide + Math.floor(xSide/2);
				var gY = Math.floor(rSum/changedNum) * ySide + Math.floor(ySide/2);
				var centroid = [gX, gY];

				return centroid;

			}
			else {
				return false;
			}
		}


		function Ball(position, radius) {
			this.path = new Path.Circle(position, radius);
			this.path.fillColor = '#f00';
			this.originPos = position;//Point

			this.move = function(destination) {
				if(destination != null){
					var vector = destination - this.path.position;
					this.path.position += vector * 0.1;
				}
			}

			this.back = function() {
				var vectorBack = this.originPos - this.path.position;
				this.path.position += vectorBack;
			}
		}


		var onFrame = function(event) {
			frame.drawCanvas();
			frame.storeFrames();

		}

		var ball1 = new Ball(new Point(500, 100), 10);
		
		var frame = new Frame();
		frame.canvas.width = $(window).width();
		frame.canvas.height = $(window).height();
		frame.getStream();

	</script>	

	<style>
		body,html {
			margin: 0;
			padding: 0;
		}
		video {			
			display: none;
		}
		canvas {
			position: absolute;
			top: 0;
			left: 0;			
		}
		#sourceCanvas {
			display: none;
		}
		#paperCanvas {
			height: 100%;
			width: 100%;
		}
		img {
			display: none;
		}
	</style>
</head>
<body>
	<video id="video" autoplay></video>
	<canvas id="sourceCanvas"></canvas>
	<canvas id="paperCanvas"></canvas>
</html>